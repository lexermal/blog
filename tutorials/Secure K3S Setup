# Setup K3s with secure connection to clients via WireGuard

Hello, this tutorial will show how to easily set up a K3s cluster.


## Situation
Let's assume you have multiple servers that are all available over the internet. This could be because you are testing out multiple hosting services or simply have multiple servers you want to connect to one cluster to keep the administration effort small.

This tutorial will show how to configure a master server and one worker node. The steps shown can be repeated for an infinitive large about of worker nodes. When the number is overgrown 10, it is recommended to look out for an automated way to set up hosts.

Therefore, let's assume the hosts have the following config:

**Master Host**
* Name: master-host
* Public IP: 1.1.1.1
* It is reachable from the internet.
* OS: Debian or Ubuntu like OS

**Worker Host**
* Name: worker-1
* Public IP: 2.2.2.2
* It is reachable from the internet.
* OS: Debian or Ubuntu like OS


## Set up the Master host
1. Enter sudo mode ```sudo su```
2. Make sure the system is up-to-date with ```apt-get update```
3. Install WireGuard: ```apt-get install wireguard -y```
4. Generate a public and private key for WireGuard ```wg genkey | tee privatekey | wg pubkey > publickey```
5. Move to the directory of WireGuard ```ch /etc/wireguard```
6. Give out the private and public keys ```echo "private key: $(cat privatekey)" && echo "public key: $(cat publickey)"```
7. Copy the keys into a text editor, you will need them in a minute.

Insert the following in the file /etc/wireguard/wg0.conf

    [Interface]
    # The IP address of this host in the wireguard tunnels
    Address = 10.1.1.1

    # Every Raspberry Pi connects via UDP to this port. Your Cloud VM must be reachable on this port via UDP from the internet.
    ListenPort = 51871

    # Set the private key to the value of the privatekey file generated by the previous command
    PrivateKey = yJQjFR18...7UiL60g=

    # Set the MTU according to the internet connections of your clients
    # In our case the autodetection assumed 8920 since the cloud network supported jumbo frames.
    MTU = 1420

Now we can bring up the WireGuard interface
```wg-quick up wg0```

### Setup K3s
Download the WireGuard install script with ```wget https://get.k3s.io -O k3s-install.sh```

Install WireGuard with ```sh k3s-install.sh --advertise-address 10.1.1.1 --flannel-iface=wg0```
This sets it up with advertising its interface to connect to the WireGuard interface with the IP we configured for the master host.

You can check now if everything worked by displaying the nodes

```kubectl get nodes```

## Conclusion


## Remarks
This tutorial is inspired by https://www.inovex.de/de/blog/how-to-set-up-a-k3s-cluster-on-wireguard/ which shows how to configure a Raspberry Pi Cluster with K3s.